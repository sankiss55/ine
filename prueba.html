<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visualizador de ActivaciÃ³n IA</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; }
        .container { position: relative; display: inline-block; margin-top: 20px; }
        #preview, #overlay-canvas { 
            position: absolute; left: 0; top: 0; 
            width: 640px; height: 640px; border-radius: 8px;
        }
        #overlay-canvas { opacity: 0.6; pointer-events: none; } /* Capa transparente arriba */
        .controls { margin: 20px; padding: 20px; background: #2a2a2a; border-radius: 10px; }
        .hidden-canvas { display: none; }
        #status { color: #00ff00; margin: 10px; }
    </style>
</head>
<body>

    <div class="controls">
        <h1>IA: Mapa de Captura Visual</h1>
        <p id="status">Cargando modelo...</p>
        <input type="file" id="fileInput" accept="image/*">
    </div>

    <div class="container" id="canvas-container" style="width: 640px; height: 640px;">
        <img id="preview" src="" style="display:none;">
        <canvas id="overlay-canvas"></canvas>
    </div>

    <canvas id="process-canvas" class="hidden-canvas"></canvas>

<script>
    const MODEL_PATH = './modelo.onnx';
    const WIDTH = 640;
    const HEIGHT = 640;
    let session;

    async function init() {
        try {
            session = await ort.InferenceSession.create(MODEL_PATH, { executionProviders: ['wasm'] });
            document.getElementById('status').innerText = "âœ… IA Lista. Sube una imagen.";
        } catch (e) {
            alert("Error al cargar modelo: " + e.message);
        }
    }

    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = document.getElementById('preview');
            img.src = event.target.result;
            img.style.display = 'block';
            img.onload = () => procesarEInyectar(img);
        };
        reader.readAsDataURL(file);
    };

    async function procesarEInyectar(imgElement) {
        const status = document.getElementById('status');
        status.innerText = "ðŸ§  Pensando...";

        const procCanvas = document.getElementById('process-canvas');
        const ctx = procCanvas.getContext('2d');
        procCanvas.width = WIDTH;
        procCanvas.height = HEIGHT;
        ctx.drawImage(imgElement, 0, 0, WIDTH, HEIGHT);

        const imageData = ctx.getImageData(0, 0, WIDTH, HEIGHT).data;
        const input = new Float32Array(WIDTH * HEIGHT * 3);
        for (let i = 0, j = 0; i < imageData.length; i += 4) {
            input[j] = imageData[i] / 255.0;
            input[j + WIDTH * HEIGHT] = imageData[i+1] / 255.0;
            input[j + 2 * WIDTH * HEIGHT] = imageData[i+2] / 255.0;
            j++;
        }

        try {
            const tensor = new ort.Tensor('float32', input, [1, 3, HEIGHT, WIDTH]);
            const results = await session.run({ images: tensor });
            const outputKey = Object.keys(results)[0];
            const outputData = results[outputKey].data;

            // DIBUJAR LO QUE LA IA VE
            dibujarMapaIA(outputData);
            status.innerText = "âœ… Captura visualizada sobre la imagen.";
        } catch (err) {
            alert("Error: " + err.message);
        }
    }

    function dibujarMapaIA(data) {
        const canvas = document.getElementById('overlay-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = WIDTH;
        canvas.height = HEIGHT;

        // Creamos una nueva imagen basada en los nÃºmeros de la IA
        const imgOut = ctx.createImageData(WIDTH, HEIGHT);
        
        // El total de valores es 310,800. Esto suele ser una matriz de probabilidad.
        // Vamos a mapear esos nÃºmeros a colores (Calor: Rojo para valores altos)
        for (let i = 0; i < WIDTH * HEIGHT; i++) {
            const valor = data[i]; // El valor de activaciÃ³n de la IA
            
            // Si el valor es alto, pintamos en Rojo neÃ³n para ver dÃ³nde "captÃ³"
            imgOut.data[i * 4 + 0] = valor > 0.5 ? 255 : 0; // Rojo
            imgOut.data[i * 4 + 1] = valor * 255;           // Verde (variaciÃ³n)
            imgOut.data[i * 4 + 2] = 0;                     // Azul
            imgOut.data[i * 4 + 3] = valor > 0.1 ? 180 : 0; // Opacidad basada en intensidad
        }

        ctx.putImageData(imgOut, 0, 0);
    }

    init();
</script>
</body>
</html>
